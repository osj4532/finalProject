<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="config.mybatis.mapper.oracle.message">
	<insert id="insertMsg" parameterType="MessageVo">
		<selectKey keyProperty="msgNo" resultType="int" order="BEFORE">
			select message_seq.nextval from dual
		</selectKey>
		insert into message(msg_no, mem_no, msg_title, msg_content)
		values(#{msgNo}, #{memNo}, #{msgTitle}, #{msgContent})
	</insert>
	
	<insert id="insertMsgRev" parameterType="MsgRevVo">
		<selectKey keyProperty="msgrevNo" resultType="int" order="BEFORE">
			select msgrev_seq.nextval from dual
		</selectKey>
		insert into msgrev(msgrev_no, mem_no, msg_no)
		values(#{msgrevNo}, #{memNo}, #{msgNo})
	</insert>
	
	<select id="selectRevMsg" parameterType="map" resultType="map">
		select B.*
		from
		(
		    select rownum RNUM, A.*
		    from
		    (
		        select MB.MEM_ID, MB.MEM_NAME,M.*,MR.MSGREV_NO, MR.MEM_NO rev_Mem, MR.MSGREV_DEL, MR.MSGREV_DATE from message M
		        join msgrev MR
		        on M.msg_no = MR.MSG_NO
		        join member MB
		        on M.MEM_NO = MB.MEM_NO
		        and MR.mem_no = #{memNo}
		        and msgRev_del = 'N'
		        <if test="keyword != null and keyword != ''">
		        and msg_title || msg_content like '%' || #{keyword} || '%'
		        </if>
		        order by msgrev_no desc
		    )A
<![CDATA[    where rownum <= #{firstRecordIndex} + #{recordCountPerPage}]]>
		)B
		where RNUM > #{firstRecordIndex}
	</select>
	
	<select id="countRevMsg" parameterType="map" resultType="int">
		select count(*) from message M
        join msgrev MR
        on M.msg_no = MR.MSG_NO
        join member MB
		on M.MEM_NO = MB.MEM_NO
        and MR.mem_no = #{memNo}
        and msgRev_del = 'N'
        <if test="keyword != null and keyword != ''">
	        and msg_title || msg_content like '%' || #{keyword} || '%'
        </if>
        order by msgrev_no desc
	</select>
	
	<select id="selectSenMsg" parameterType="map" resultType="map">
		select B.*
		from
		(
		    select rownum RNUM, A.*
		    from
		    (
		        select MB.MEM_ID, MB.MEM_NAME, M.*,MR.MSGREV_NO, MR.MEM_NO rev_Mem, MR.MSGREV_DEL, MR.MSGREV_DATE from message M
				join msgrev MR
				on M.msg_no = MR.MSG_NO
				join member MB
				on M.MEM_NO = MB.MEM_NO
				and M.MEM_NO = #{memNo}
				and msg_del = 'N'
				<if test="keyword != null and keyword !=''">
				and msg_title || msg_content like '%' || #{keyword} || '%'
				</if>
				order by M.msg_no desc
		    )A
<![CDATA[   where rownum <= #{firstRecordIndex} + #{recordCountPerPage}]]>
		)B
		where RNUM > #{firstRecordIndex}
	</select>
	
	<select id="countSenMsg" parameterType="map" resultType="int">
		 select count(*) from message M
				join msgrev MR
				on M.msg_no = MR.MSG_NO
				join member MB
				on M.MEM_NO = MB.MEM_NO
				and M.MEM_NO = #{memNo}
				and msg_del = 'N'
				<if test="keyword != null and keyword !=''">
				and msg_title || msg_content like '%' || #{keyword} || '%'
				</if>
				order by M.msg_no desc
	</select>
</mapper>









